import { useEffect, useState } from 'react'
import { useNavigate } from 'react-router-dom'
import { createLecture, saveLectureTab, listSubjects, putTempFile, deleteTempFile } from '@/lib/repo'
import { log } from '@/lib/logs'

// Lazy load AI module
type AiModule = typeof import('@/lib/ai')
let aiModPromise: Promise<AiModule> | null = null
async function ai() { return (aiModPromise ??= import('@/lib/ai')) }

export default function NewLecture() {
  const navigate = useNavigate()
  const [subjectId, setSubjectId] = useState('')
  const [audio, setAudio] = useState<File | null>(null)
  const [status, setStatus] = useState<string>('Gotowe')
  const [error, setError] = useState<string | null>(null)
  const [subjects, setSubjects] = useState<{id:string;name:string}[]>([])
  const [dragOver, setDragOver] = useState(false)
  const [progress, setProgress] = useState<{ value: number; phase: string } | null>(null)
  const [audioWarning, setAudioWarning] = useState<string | null>(null)

  useEffect(() => { (async () => setSubjects(await listSubjects()))() }, [])

  useEffect(() => {
    if (!audio) {
      setAudioWarning(null)
      return
    }
    
    const sizeMB = audio.size / 1024 / 1024
    const estimatedMinutes = sizeMB / 0.7
    
    if (sizeMB > 100) {
      setAudioWarning(
        `‚ö†Ô∏è DU≈ªY PLIK (${sizeMB.toFixed(0)}MB, ~${estimatedMinutes.toFixed(0)} minut)\n` +
        `\nTranskrypcja w przeglƒÖdarce zajƒô≈Çaby ${(estimatedMinutes * 0.7).toFixed(0)}-${(estimatedMinutes * 1.2).toFixed(0)} minut!\n` +
        `\nüöÄ ZALECENIE: U≈ºyj backendu (cd server && npm start)`
      )
    } else if (sizeMB > 20) {
      setAudioWarning(
        `‚ÑπÔ∏è Plik ${sizeMB.toFixed(0)}MB (~${estimatedMinutes.toFixed(0)} min)\n` +
        `Szacowany czas:\n` +
        `‚Ä¢ Backend: ~${(estimatedMinutes * 0.1).toFixed(0)} min\n` +
        `‚Ä¢ PrzeglƒÖdarka: ~${(estimatedMinutes * 0.7).toFixed(0)} min`
      )
    }
  }, [audio])

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault()
    if (!subjectId) return setStatus('Wybierz przedmiot')
    if (!audio) return setStatus('Dodaj plik audio')
    
    setError(null)
    
    try {
      setStatus('Tworzenie wyk≈Çadu...')
      log('[NewLecture] Start procesu')
      
      let speechText = ''
      let tempAudioId: string | null = null

      // === TRANSKRYPCJA ===
      setStatus('Zapisywanie audio...')
      log('[NewLecture] Zapis audio do cache')
      const ab = await audio.arrayBuffer()
      const blob = new Blob([ab], { type: audio.type || 'audio/mpeg' })
      tempAudioId = await putTempFile('audio', blob)
      
      setStatus('Transkrypcja audio...')
      log('[NewLecture] Start transkrypcji')
      
      try {
        const { transcribeAudio } = await ai()
        const t = await transcribeAudio(blob, 'auto', (p, phase) => setProgress({ value: p, phase }))
        speechText = t.text
        log(`[NewLecture] Transkrypcja zako≈Ñczona: ${speechText.length} znak√≥w`)
      } catch (err: any) {
        const errorMsg = `B≈ÇƒÖd transkrypcji: ${err?.message || err}`
        log(errorMsg)
        setStatus(errorMsg)
        throw err
      } finally {
        if (tempAudioId) {
          await deleteTempFile(tempAudioId)
          log('[NewLecture] Usuniƒôto audio z cache')
        }
      }

      // === GENEROWANIE TYTU≈ÅU ===
      setStatus('Generowanie tytu≈Çu (AI)...')
      log('[NewLecture] Generowanie tytu≈Çu z transkrypcji')
      
      const { generateWithAI } = await ai()
      const titlePrompt = `Na podstawie transkrypcji wyk≈Çadu wygeneruj kr√≥tki, zwiƒôz≈Çy tytu≈Ç wyk≈Çadu (maksymalnie 5-6 s≈Ç√≥w).

TRANSKRYPCJA:
"${speechText.substring(0, 2000)}"${speechText.length > 2000 ? '...' : ''}

Format: "Wprowadzenie do...", "Podstawy...", "Wyk≈Çad o...", itp.

TYLKO TYTU≈Å (bez cudzys≈Çow√≥w, bez dodatkowego tekstu):`

      const generatedTitle = await generateWithAI(titlePrompt, 'notes')
      const cleanTitle = generatedTitle.trim().replace(/^["']|["']$/g, '') // Usu≈Ñ cudzys≈Çowy
      
      log(`[NewLecture] Wygenerowany tytu≈Ç: "${cleanTitle}"`)
      setStatus(`Tytu≈Ç: "${cleanTitle}"`)

      // === TWORZENIE WYK≈ÅADU ===
      setStatus('Tworzenie wyk≈Çadu...')
      const lecture = await createLecture(subjectId, cleanTitle)
      log(`[NewLecture] Wyk≈Çad utworzony: ${lecture.id}`)

      // Zapisz surowƒÖ transkrypcjƒô
      await saveLectureTab(lecture.id, 'transcript', speechText)
      log('[NewLecture] Zapisano transkrypcjƒô')
      setStatus('Transkrypcja zapisana ‚úÖ')

      // === CZYSZCZENIE ===
      setStatus('Czyszczenie transkrypcji (AI)...')
      log('[NewLecture] Start cleaning')
      
      const { cleanTextWithAI } = await ai()
      const cleaned = await cleanTextWithAI(speechText)
      
      await saveLectureTab(lecture.id, 'cleaned', cleaned.cleanedText)
      log(`[NewLecture] Zapisano oczyszczonƒÖ transkrypcjƒô: ${cleaned.cleanedText.length} znak√≥w`)
      setStatus('Oczyszczona transkrypcja zapisana ‚úÖ')

      setStatus('‚úÖ Gotowe! Przekierowanie...')
      log(`[NewLecture] Zako≈Ñczono - przekierowanie do /lecture/${lecture.id}`)

      // Przekieruj do widoku wyk≈Çadu
      setTimeout(() => {
        log(`[NewLecture] Wykonujƒô navigate do /lecture/${lecture.id}`)
        navigate(`/lecture/${lecture.id}`)
      }, 1000)
      
    } catch (err: any) {
      const errorMsg = `B≈ÇƒÖd: ${err?.message || 'Nieznany b≈ÇƒÖd'}`
      log(`[NewLecture] B≈ÅƒÑD: ${errorMsg}`)
      setStatus(errorMsg)
      setError(errorMsg)
    }
  }

  function handleDrop(e: React.DragEvent) {
    e.preventDefault()
    setDragOver(false)
    const file = e.dataTransfer.files[0]
    if (file && file.type.startsWith('audio/')) {
      setAudio(file)
    }
  }

  return (
    <section className="space-y-8">
      <div className="text-center pb-8">
        <h1 className="text-4xl font-bold mb-4 bg-gradient-to-r from-blue-600 to-cyan-600 bg-clip-text text-transparent">
          üéì Nowy Wyk≈Çad
        </h1>
        <p className="text-gray-600 dark:text-gray-300">
          Nagraj lub wgraj audio wyk≈Çadu - AI stworzy transkrypcjƒô i oczyszczonƒÖ wersjƒô
        </p>
      </div>

      {error && (
        <div className="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4 text-red-800 dark:text-red-200">
          {error}
        </div>
      )}

      <form onSubmit={handleSubmit} className="space-y-6 max-w-2xl mx-auto">
        {/* Przedmiot */}
        <div>
          <label className="block text-sm font-medium mb-2">Przedmiot</label>
          <select 
            value={subjectId}
            onChange={e => setSubjectId(e.target.value)}
            className="w-full px-4 py-2 rounded-lg border dark:bg-gray-800"
            required
          >
            <option value="">Wybierz przedmiot</option>
            {subjects.map(s => (
              <option key={s.id} value={s.id}>{s.name}</option>
            ))}
          </select>
          <p className="text-xs text-gray-500 dark:text-gray-400 mt-2">
            üí° Tytu≈Ç wyk≈Çadu zostanie automatycznie wygenerowany z tre≈õci
          </p>
        </div>

        {/* Audio Upload */}
        <div>
          <label className="block text-sm font-medium mb-2">Plik audio</label>
          <div
            className={`border-2 border-dashed rounded-lg p-8 text-center transition-colors ${
              dragOver ? 'border-blue-500 bg-blue-50 dark:bg-blue-900/20' : 'border-gray-300 dark:border-gray-700'
            }`}
            onDragOver={e => { e.preventDefault(); setDragOver(true) }}
            onDragLeave={() => setDragOver(false)}
            onDrop={handleDrop}
          >
            {audio ? (
              <div className="space-y-2">
                <p className="font-medium">{audio.name}</p>
                <p className="text-sm text-gray-500">
                  {(audio.size / 1024 / 1024).toFixed(2)} MB
                </p>
                <button
                  type="button"
                  onClick={() => setAudio(null)}
                  className="text-sm text-red-600 hover:underline"
                >
                  Usu≈Ñ
                </button>
              </div>
            ) : (
              <div>
                <p className="mb-2">PrzeciƒÖgnij plik audio tutaj lub</p>
                <input
                  type="file"
                  accept="audio/*"
                  onChange={e => setAudio(e.target.files?.[0] || null)}
                  className="hidden"
                  id="audio-input"
                />
                <label
                  htmlFor="audio-input"
                  className="inline-block px-4 py-2 bg-blue-600 text-white rounded-lg cursor-pointer hover:bg-blue-700"
                >
                  Wybierz plik
                </label>
              </div>
            )}
          </div>

          {audioWarning && (
            <div className="mt-2 p-3 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded text-sm whitespace-pre-line">
              {audioWarning}
            </div>
          )}
        </div>

        {/* Progress */}
        {progress && (
          <div className="space-y-2">
            <div className="flex justify-between text-sm">
              <span>{progress.phase}</span>
              <span>{progress.value}%</span>
            </div>
            <div className="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
              <div
                className="bg-blue-600 h-2 rounded-full transition-all"
                style={{ width: `${progress.value}%` }}
              />
            </div>
          </div>
        )}

        {/* Status */}
        {status !== 'Gotowe' && (
          <div className="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg text-center">
            {status}
          </div>
        )}

        {/* Submit */}
        <button
          type="submit"
          disabled={!subjectId || !audio || (status !== 'Gotowe' && !error)}
          className="w-full px-6 py-3 bg-gradient-to-r from-blue-600 to-cyan-600 text-white rounded-lg font-medium hover:opacity-90 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Utw√≥rz wyk≈Çad i transkrybuj
        </button>

        <div className="text-sm text-gray-500 dark:text-gray-400 space-y-1">
          <p>üí° Po transkrypcji bƒôdziesz m√≥g≈Ç wygenerowaƒá:</p>
          <ul className="list-disc list-inside ml-4 space-y-1">
            <li>Szczeg√≥≈ÇowƒÖ notatkƒô</li>
            <li>Kr√≥tkƒÖ notatkƒô i kluczowe punkty</li>
            <li>Bank pyta≈Ñ i quiz</li>
            <li>Fiszki do nauki</li>
            <li>Mapƒô my≈õli</li>
            <li>Chat z wyk≈Çadem (pytaj AI o tre≈õƒá)</li>
          </ul>
        </div>
      </form>
    </section>
  )
}
